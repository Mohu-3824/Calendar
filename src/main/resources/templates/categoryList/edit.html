<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <div th:replace="~{fragment :: meta}"></div>
    <div th:replace="~{fragment :: styles}"></div>
    <title>カテゴリー編集</title>
</head>
<body>
<div class="edelweiss-wrapper">
    <div th:replace="~{fragment :: header}"></div>

    <main class="container pt-4 pb-5 edelweiss-container">
        <h3 class="title mb-4" th:text="${isEdit} ? 'カテゴリー編集' : 'カテゴリー新規作成'"></h3>

        <form th:action="${isEdit} ? @{'/categories/update/' + ${categoryId}} : @{/categories/save}"
              th:object="${categoryForm}"
              method="post" class="row g-3">

            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <!-- カテゴリー名 -->
            <div class="col-12">
                <label class="form-label">カテゴリー名</label>
                <input type="text" th:field="*{categoryName}" class="form-control" placeholder="例) 運動"/>
                <div class="text-danger small" th:errors="*{categoryName}"></div>
            </div>

            <!-- アイコン選択 -->
            <div class="col-12">
                <label class="form-label">アイコン</label>
                <div class="d-flex flex-wrap gap-2">
                    <div th:each="icon : ${iconList}"
                         class="icon-item p-2 border"
                         style="width:60px; height:60px; cursor:pointer; text-align:center;"
                         th:attr="data-icon=${icon}">
                        <img th:src="@{'/img/' + ${icon}}" alt="icon"
                             style="width:40px; height:40px;" />
                    </div>
                </div>
                <!-- hidden に保存 -->
                <input type="hidden" th:field="*{iconImage}" id="iconImage" />
            </div>

            <!-- カラー選択 -->
            <div class="col-12">
                <label class="form-label">カラー</label>
                <div class="d-flex flex-wrap gap-2">
                    <div th:each="color : ${colorList}"
     					class="color-swatch"
     					th:attr="data-color=${color}"
     					th:style="'background-color:' + ${color} + '; width:40px; height:40px; border:2px solid #ddd; cursor:pointer;'">
					</div>
                </div>
                <input type="hidden" th:field="*{colorCode}" id="colorCode" />
            </div>

            <!-- ボタン -->
            <div class="col-12 mt-3 text-center">
                <button type="submit" class="btn btn-primary" th:text="${isEdit} ? '更新' : '登録'"></button>
                <a th:href="@{/categoryList}" class="btn btn-outline-secondary ms-2">戻る</a>
            </div>
        </form>
    </main>

    <div th:replace="~{fragment :: footer}"></div>
    <div th:replace="~{fragment :: scripts}"></div>
</div>
<script>
(function() {
    $(document).ready(function() {
        const $iconItems = $(".icon-item");
        const $iconField = $("#iconImage");

        // ======================
        // アイコンクリック処理
        // ======================
        $iconItems.on("click", function() {
            const iconName = $(this).data("icon");

            // hiddenフィールドにセット
            $iconField.val(iconName);

            // 選択状態を更新
            $iconItems.removeClass("selected");
            $(this).addClass("selected");
        });

        // ======================
        // 編集時の初期選択状態反映
        // ======================
        const currentVal = $iconField.val();
        if (currentVal) {
            const $currentItem = $iconItems.filter(`[data-icon="${currentVal}"]`);
            if ($currentItem.length > 0) {
                $currentItem.addClass("selected");
            }
        }

        // ======================
        // カラークリック処理
        // ======================
        const $colorItems = $(".color-swatch");
        const $colorField = $("#colorCode");

        $colorItems.on("click", function() {
            const colorCode = $(this).data("color");

            // hiddenフィールドにセット
            $colorField.val(colorCode);

            // 選択状態を更新
            $colorItems.removeClass("selected");
            $(this).addClass("selected");
        });

        // ======================
        // 編集時の初期カラー反映
        // ======================
        const currentColorVal = $colorField.val();
        if (currentColorVal) {
            const $currentColorItem = $colorItems.filter(`[data-color="${currentColorVal}"]`);
            if ($currentColorItem.length > 0) {
                $currentColorItem.addClass("selected");
            }
        }
    });
})();
</script>
</body>
</html>